import{A as B,r as b}from"./request-CSTMYV-j.js";import{_ as D,u as $,r as c,k as j,l as F,h as N,c as g,a as p,q as O,v as T,b as s,w as o,d as v,E as i,o as P,A as k,f as y,t as W}from"./index-CVtVCzsP.js";const M={class:"profile-root"},z={class:"profile-card"},G={class:"avatar-section"},H=["src"],J={key:1,class:"avatar-placeholder"},K={class:"info-section"},Q={class:"password-card"},X={__name:"Profile",setup(Y){const f=$(),t=c({username:"",studentId:"",email:"",avatar:""}),w=c(!1),m=c(""),_=c(null),R={username:[{required:!0,message:"è¯·è¾“å…¥ç”¨æˆ·å",trigger:"blur"}],studentId:[{required:!0,message:"è¯·è¾“å…¥å­¦å·",trigger:"blur"}],email:[{type:"email",message:"è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€",trigger:"blur"}]},r=c({oldPassword:"",newPassword:"",confirmPassword:""}),q={oldPassword:[{required:!0,message:"è¯·è¾“å…¥æ—§å¯†ç ",trigger:"blur"}],newPassword:[{required:!0,message:"è¯·è¾“å…¥æ–°å¯†ç ",trigger:"blur"}],confirmPassword:[{required:!0,message:"è¯·ç¡®è®¤æ–°å¯†ç ",trigger:"blur"},{validator:(a,e,l)=>{e!==r.value.newPassword?l(new Error("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´")):l()},trigger:"blur"}]},x=a=>{if(!a)return"/default-avatar.png";if(a.startsWith("http://")||a.startsWith("https://"))return a;const e=B.replace(/\/$/,""),l=a.startsWith("/")?a:`/${a}`;return`${e}${l}`},V=j(()=>m.value||x(t.value.avatar)),U=async()=>{var a;w.value=!0;try{const l=((a=(await b.get("/users/me/profile")).data)==null?void 0:a.data)||{};t.value={username:l.username||"",studentId:l.studentId||"",email:l.email||"",avatar:l.avatar||""},f.updateProfile(l)}catch(e){console.error("è·å–ä¸ªäººèµ„æ–™å¤±è´¥:",e),i.error("åŠ è½½èµ„æ–™å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}finally{w.value=!1}},L=a=>{m.value&&URL.revokeObjectURL(m.value),_.value=a.raw,m.value=URL.createObjectURL(a.raw)},A=async()=>{var e,l;if(!t.value.username){i.warning("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");return}const a=new FormData;a.append("username",t.value.username),a.append("studentId",t.value.studentId||""),a.append("email",t.value.email||""),_.value&&a.append("avatar",_.value);try{await b.put("/users/me/profile",a,{headers:{"Content-Type":"multipart/form-data"}}),i.success("èµ„æ–™å·²æ›´æ–°"),_.value=null,m.value="",await U()}catch(d){console.error("æ›´æ–°èµ„æ–™å¤±è´¥:",d),i.error(((l=(e=d.response)==null?void 0:e.data)==null?void 0:l.error)||"æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}},C=async()=>{var a,e;if(!r.value.oldPassword||!r.value.newPassword||!r.value.confirmPassword){i.warning("è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å­—æ®µ");return}if(r.value.oldPassword===r.value.newPassword){i.warning("æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ");return}if(r.value.newPassword!==r.value.confirmPassword){i.error("ä¸¤æ¬¡æ–°å¯†ç ä¸ä¸€è‡´");return}try{await b.put("/users/me/password",{oldPassword:r.value.oldPassword,newPassword:r.value.newPassword}),i.success("å¯†ç ä¿®æ”¹æˆåŠŸ"),r.value={oldPassword:"",newPassword:"",confirmPassword:""}}catch(l){console.error("ä¿®æ”¹å¯†ç å¤±è´¥:",l),i.error(((e=(a=l.response)==null?void 0:a.data)==null?void 0:e.error)||"å¯†ç ä¿®æ”¹å¤±è´¥")}};return F(()=>{f.load(),U()}),N(()=>{m.value&&URL.revokeObjectURL(m.value)}),(a,e)=>{const l=v("el-upload"),d=v("el-input"),u=v("el-form-item"),E=v("el-tag"),I=v("el-button"),h=v("el-form"),S=T("loading");return P(),g("div",M,[e[10]||(e[10]=p("h1",{class:"page-title"},"ğŸ‘¤ æˆ‘çš„èµ„æ–™",-1)),O((P(),g("div",z,[p("div",G,[s(l,{class:"avatar-uploader",action:"#","show-file-list":!1,"auto-upload":!1,"on-change":L,accept:"image/*"},{default:o(()=>[V.value?(P(),g("img",{key:0,src:V.value,class:"avatar-img"},null,8,H)):(P(),g("div",J,"ä¸Šä¼ å¤´åƒ"))]),_:1}),e[6]||(e[6]=p("p",{class:"avatar-tip"},"ç‚¹å‡»å¤´åƒå¯æ›´æ¢",-1))]),p("div",K,[s(h,{model:t.value,rules:R,"label-width":"100px",class:"info-form"},{default:o(()=>[s(u,{label:"ç”¨æˆ·å",prop:"username"},{default:o(()=>[s(d,{modelValue:t.value.username,"onUpdate:modelValue":e[0]||(e[0]=n=>t.value.username=n)},null,8,["modelValue"])]),_:1}),s(u,{label:"å­¦å·",prop:"studentId"},{default:o(()=>[s(d,{modelValue:t.value.studentId,"onUpdate:modelValue":e[1]||(e[1]=n=>t.value.studentId=n)},null,8,["modelValue"])]),_:1}),s(u,{label:"é‚®ç®±",prop:"email"},{default:o(()=>[s(d,{modelValue:t.value.email,"onUpdate:modelValue":e[2]||(e[2]=n=>t.value.email=n)},null,8,["modelValue"])]),_:1}),s(u,{label:"è§’è‰²"},{default:o(()=>[s(E,{type:k(f).role==="admin"?"danger":"success"},{default:o(()=>[y(W(k(f).role==="admin"?"ç®¡ç†å‘˜":"æ™®é€šç”¨æˆ·"),1)]),_:1},8,["type"])]),_:1}),s(u,null,{default:o(()=>[s(I,{type:"primary",onClick:A,loading:w.value},{default:o(()=>e[7]||(e[7]=[y("ä¿å­˜ä¿®æ”¹")])),_:1,__:[7]},8,["loading"])]),_:1})]),_:1},8,["model"])])])),[[S,w.value]]),p("div",Q,[e[9]||(e[9]=p("h3",{class:"section-title"},"ğŸ”’ ä¿®æ”¹å¯†ç ",-1)),s(h,{model:r.value,rules:q,"label-width":"100px",class:"password-form"},{default:o(()=>[s(u,{label:"æ—§å¯†ç ",prop:"oldPassword"},{default:o(()=>[s(d,{modelValue:r.value.oldPassword,"onUpdate:modelValue":e[3]||(e[3]=n=>r.value.oldPassword=n),type:"password"},null,8,["modelValue"])]),_:1}),s(u,{label:"æ–°å¯†ç ",prop:"newPassword"},{default:o(()=>[s(d,{modelValue:r.value.newPassword,"onUpdate:modelValue":e[4]||(e[4]=n=>r.value.newPassword=n),type:"password"},null,8,["modelValue"])]),_:1}),s(u,{label:"ç¡®è®¤æ–°å¯†ç ",prop:"confirmPassword"},{default:o(()=>[s(d,{modelValue:r.value.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=n=>r.value.confirmPassword=n),type:"password"},null,8,["modelValue"])]),_:1}),s(u,null,{default:o(()=>[s(I,{type:"primary",onClick:C},{default:o(()=>e[8]||(e[8]=[y("æ›´æ–°å¯†ç ")])),_:1,__:[8]})]),_:1})]),_:1},8,["model"])])])}}},ae=D(X,[["__scopeId","data-v-6f5e91b4"]]);export{ae as default};
