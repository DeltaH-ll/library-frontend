import{r as f,g as M,h as X,d as v,i as G,o as C,w as s,b as o,a as c,c as $,f as b,_ as Y,l as Z,q as ee,s as te,v as le,E as V,t as j,x as oe}from"./index-CVtVCzsP.js";import{r as B,A as ae}from"./request-CSTMYV-j.js";const re={style:{"margin-top":"8px",display:"flex",gap:"12px","align-items":"center"}},se={key:0},ne=["src"],ie={key:1},ue=["src"],pe={key:2,style:{color:"#999"}},de={__name:"BookDialog",props:{modelValue:Boolean,isEdit:Boolean,formData:Object},emits:["update:modelValue","submit"],setup(z,{emit:E}){const w=z,x=E,g=f(w.modelValue),D=f(null),a=f({id:null,title:"",author:"",price:0,publish_date:"",total_count:1,status:"",cover_url:null,coverFile:null,cover_preview:null}),h={title:[{required:!0,message:"è¯·è¾“å…¥ä¹¦å",trigger:"blur"}],author:[{required:!0,message:"è¯·è¾“å…¥ä½œè€…",trigger:"blur"}],price:[{required:!0,message:"è¯·è¾“å…¥ä»·æ ¼",trigger:"blur"},{type:"number",min:0,message:"ä»·æ ¼ä¸èƒ½ä¸ºè´Ÿæ•°",trigger:"change"}],publish_date:[{required:!0,message:"è¯·é€‰æ‹©å‡ºç‰ˆæ—¥æœŸ",trigger:"change"}],total_count:[{required:!0,message:"è¯·è¾“å…¥æ€»æ•°é‡",trigger:"change"}]};M(()=>w.modelValue,r=>{g.value=r}),M(g,r=>x("update:modelValue",r)),M(()=>w.formData,r=>{a.value.cover_preview&&URL.revokeObjectURL(a.value.cover_preview),r?a.value={...r,price:typeof r.price=="number"?r.price:Number(r.price)||0,coverFile:null,cover_preview:null}:a.value={id:null,title:"",author:"",price:0,publish_date:"",total_count:1,status:"",cover_url:null,coverFile:null,cover_preview:null}},{immediate:!0}),X(()=>{a.value.cover_preview&&URL.revokeObjectURL(a.value.cover_preview)});const S=()=>{g.value=!1},R=r=>{const l=r.target.files&&r.target.files[0];if(l){if(a.value.cover_preview)try{URL.revokeObjectURL(a.value.cover_preview)}catch{}a.value.coverFile=l,a.value.cover_preview=URL.createObjectURL(l)}},U=r=>{r===""||r===null||isNaN(Number(r))?a.value.price=0:a.value.price=Number(r)},F=()=>{a.value.price=Number(a.value.price)||0,D.value.validate(r=>{if(!r)return;const l={...a.value};l.publish_date instanceof Date&&(l.publish_date=l.publish_date.toISOString().slice(0,10)),x("submit",{id:l.id,title:l.title,author:l.author,price:l.price,publish_date:l.publish_date,total_count:l.total_count,status:l.status,cover_url:l.cover_url,coverFile:l.coverFile}),g.value=!1})},T=r=>r?r.startsWith("http://")||r.startsWith("https://")?r:window.location.origin+r:"";return(r,l)=>{const k=v("el-input"),y=v("el-form-item"),q=v("el-date-picker"),O=v("el-input-number"),L=v("el-option"),I=v("el-select"),A=v("el-form"),P=v("el-button"),W=v("el-dialog");return C(),G(W,{title:z.isEdit?"ç¼–è¾‘å›¾ä¹¦":"æ–°å¢žå›¾ä¹¦",modelValue:g.value,"onUpdate:modelValue":l[6]||(l[6]=m=>g.value=m),width:"520px",onClose:S},{footer:s(()=>[o(P,{onClick:S},{default:s(()=>l[10]||(l[10]=[b("å–æ¶ˆ")])),_:1,__:[10]}),o(P,{type:"primary",onClick:F},{default:s(()=>l[11]||(l[11]=[b("ç¡®å®š")])),_:1,__:[11]})]),default:s(()=>[o(A,{model:a.value,rules:h,ref_key:"formRef",ref:D,"label-width":"100px"},{default:s(()=>[o(y,{label:"ä¹¦å",prop:"title"},{default:s(()=>[o(k,{modelValue:a.value.title,"onUpdate:modelValue":l[0]||(l[0]=m=>a.value.title=m),autocomplete:"off"},null,8,["modelValue"])]),_:1}),o(y,{label:"ä½œè€…",prop:"author"},{default:s(()=>[o(k,{modelValue:a.value.author,"onUpdate:modelValue":l[1]||(l[1]=m=>a.value.author=m),autocomplete:"off"},null,8,["modelValue"])]),_:1}),o(y,{label:"å›¾ä¹¦ä»·æ ¼",prop:"price"},{default:s(()=>[o(k,{modelValue:a.value.price,"onUpdate:modelValue":l[2]||(l[2]=m=>a.value.price=m),type:"number",step:"0.01",min:"0",autocomplete:"off",placeholder:"è¯·è¾“å…¥ä»·æ ¼ï¼ˆå…ƒï¼‰",onInput:U},null,8,["modelValue"])]),_:1}),o(y,{label:"å‡ºç‰ˆæ—¥æœŸ",prop:"publish_date"},{default:s(()=>[o(q,{modelValue:a.value.publish_date,"onUpdate:modelValue":l[3]||(l[3]=m=>a.value.publish_date=m),type:"date",placeholder:"é€‰æ‹©æ—¥æœŸ",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),o(y,{label:"æ€»æ•°é‡",prop:"total_count"},{default:s(()=>[o(O,{modelValue:a.value.total_count,"onUpdate:modelValue":l[4]||(l[4]=m=>a.value.total_count=m),min:1,style:{width:"160px"}},null,8,["modelValue"])]),_:1}),o(y,{label:"çŠ¶æ€ï¼ˆå¯é€‰ï¼‰",prop:"status"},{default:s(()=>[o(I,{modelValue:a.value.status,"onUpdate:modelValue":l[5]||(l[5]=m=>a.value.status=m),placeholder:"è¯·é€‰æ‹©"},{default:s(()=>[o(L,{label:"åœ¨é¦†",value:"åœ¨é¦†"}),o(L,{label:"å€Ÿå‡º",value:"å€Ÿå‡º"})]),_:1},8,["modelValue"]),l[7]||(l[7]=c("div",{style:{"font-size":"12px",color:"#999","margin-top":"6px"}}," æç¤ºï¼šç³»ç»Ÿæ˜¾ç¤ºçŠ¶æ€ä»¥ã€Œæ€»æ•° / å¯å€Ÿã€ä¸ºå‡†ï¼Œæ­¤å­—æ®µä»…ä½œå¤‡æ³¨ã€‚ ",-1))]),_:1,__:[7]}),o(y,{label:"å°é¢"},{default:s(()=>[c("input",{type:"file",accept:"image/*",onChange:R},null,32),c("div",re,[a.value.cover_preview?(C(),$("div",se,[l[8]||(l[8]=c("div",{style:{"font-size":"12px",color:"#666","margin-bottom":"6px"}},"æœ¬åœ°é¢„è§ˆ",-1)),c("img",{src:a.value.cover_preview,alt:"å°é¢é¢„è§ˆ",style:{width:"90px",height:"120px","object-fit":"cover","border-radius":"4px"}},null,8,ne)])):a.value.cover_url?(C(),$("div",ie,[l[9]||(l[9]=c("div",{style:{"font-size":"12px",color:"#666","margin-bottom":"6px"}},"å½“å‰å°é¢",-1)),c("img",{src:T(a.value.cover_url),alt:"å½“å‰å°é¢",style:{width:"90px",height:"120px","object-fit":"cover","border-radius":"4px"}},null,8,ue)])):(C(),$("div",pe,"æœªé€‰æ‹©å°é¢"))])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])}}},ce={class:"books-root"},me={class:"books-header"},ve={class:"books-actions"},_e={class:"price-filter"},fe=["src"],ge={key:1,class:"no-cover"},be={style:{"line-height":"1.1"}},he={style:{color:"#999"}},ye={class:"pager",style:{display:"flex","justify-content":"flex-end","margin-top":"12px"}},we={__name:"Books",setup(z){const E=f([]),w=f(""),x=f(!1),g=f(!1),D=f(null),a=f(!1),h=f(1),S=f(6),R=f(0),U=f(""),F=f(""),T=e=>{const t=Number(e);return Number.isFinite(t)?`Â¥${t.toFixed(2)}`:"Â¥0.00"},r=async()=>{var e;a.value=!0;try{const n=(await B.get("/books",{params:{page:h.value,limit:S.value,keyword:w.value||void 0,minPrice:U.value?Number(U.value):void 0,maxPrice:F.value?Number(F.value):void 0}})).data||{};E.value=n.data||[],R.value=n.total||0}catch(t){console.error("åŠ è½½å›¾ä¹¦å¤±è´¥:",t);const n=((e=t.response)==null?void 0:e.status)===404?"æŽ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åŽç«¯æ˜¯å¦å¯åŠ¨æˆ–è·¯å¾„æ˜¯å¦æ­£ç¡®":"åŠ è½½å›¾ä¹¦å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•";V.error(n)}finally{a.value=!1}},l=()=>{h.value=1,r()},k=()=>{h.value=1,w.value="",r()},y=e=>{h.value=e,r()},q=()=>{h.value=1,r()},O=()=>{U.value="",F.value="",h.value=1,r()},L=(e,t,n)=>{if(!n)return"â€”";const i=new Date(n);return isNaN(i.getTime())?n:i.toLocaleDateString()},I=e=>{if(!e)return"";if(e.startsWith("http://")||e.startsWith("https://"))return e;const t=ae.replace(/\/$/,""),n=e.startsWith("/")?e:`/${e}`;return`${t}${n}`},A=()=>{g.value=!1,D.value={total_count:1,price:0},x.value=!0},P=e=>{g.value=!0,D.value={id:e.id,title:e.title,author:e.author,publish_date:e.publish_date||"",total_count:e.total_count??1,cover_url:e.cover_url||null,price:typeof e.price=="number"?e.price:0},x.value=!0},W=async e=>{var t,n,i,d;try{e.publish_date instanceof Date&&(e.publish_date=e.publish_date.toISOString().slice(0,10));const p=typeof e.price=="number"?e.price:Number(e.price)||0;if(e.coverFile instanceof File){const _=new FormData;_.append("title",e.title),_.append("author",e.author||""),_.append("publisher",e.publisher||""),_.append("publish_date",e.publish_date||""),_.append("total_count",e.total_count??1),_.append("price",p),_.append("cover",e.coverFile),g.value?(await B.put(`/books/${e.id}`,_,{headers:{"Content-Type":"multipart/form-data"}}),V.success("å›¾ä¹¦ç¼–è¾‘æˆåŠŸ")):(await B.post("/books",_,{headers:{"Content-Type":"multipart/form-data"}}),V.success("æ–°å¢žå›¾ä¹¦æˆåŠŸ"))}else{const _={title:e.title,author:e.author,publisher:e.publisher||null,publish_date:e.publish_date,total_count:e.total_count??1,cover_url:e.cover_url||null,price:p};g.value?(await B.put(`/books/${e.id}`,_),V.success("å›¾ä¹¦ç¼–è¾‘æˆåŠŸ")):(await B.post("/books",_),V.success("æ–°å¢žå›¾ä¹¦æˆåŠŸ"))}x.value=!1,r()}catch(p){console.error("ä¿å­˜å›¾ä¹¦å¤±è´¥:",p);let N="ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–æœåŠ¡å™¨çŠ¶æ€";(n=(t=p==null?void 0:p.response)==null?void 0:t.data)!=null&&n.error?N=p.response.data.error:(d=(i=p==null?void 0:p.response)==null?void 0:i.data)!=null&&d.message?N=p.response.data.message:p!=null&&p.message&&(N=p.message),V.error(N)}},m=async e=>{var t,n;try{await oe.confirm("ç¡®å®šè¦åˆ é™¤è¿™æœ¬å›¾ä¹¦å—ï¼Ÿ","åˆ é™¤ç¡®è®¤",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"}),await B.delete(`/books/${e}`),V.success("åˆ é™¤æˆåŠŸ"),r()}catch(i){if(i&&i!=="cancel"){console.error("åˆ é™¤å›¾ä¹¦å¤±è´¥:",i);const d=((n=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:n.error)||"åˆ é™¤å¤±è´¥";V.error(d)}}},K=e=>{const t=Number(e.total_count),n=Number(e.available_count),i=Number.isFinite(t)?t:0,d=Number.isFinite(n)?n:0;return i<=0?"ä¸å¯å€Ÿé˜…":d>=i?"å…¨éƒ¨åœ¨é¦†":d<=0?"ä¸å¯å€Ÿé˜…":"éƒ¨åˆ†å€Ÿå‡º"},H=e=>{const t=K(e);return t==="å…¨éƒ¨åœ¨é¦†"?"success":t==="éƒ¨åˆ†å€Ÿå‡º"?"warning":"danger"};return Z(()=>{r()}),(e,t)=>{const n=v("el-input"),i=v("el-button"),d=v("el-table-column"),p=v("el-tag"),N=v("el-table"),_=v("el-pagination"),J=le("loading");return C(),$("div",ce,[c("div",me,[t[8]||(t[8]=c("h1",{class:"books-title"},"ðŸ“š å›¾ä¹¦ç®¡ç†",-1)),c("div",ve,[o(n,{modelValue:w.value,"onUpdate:modelValue":t[0]||(t[0]=u=>w.value=u),placeholder:"æœç´¢ä¹¦åæˆ–ä½œè€…ï¼ˆæŒ‰å›žè½¦æŸ¥è¯¢ï¼‰",clearable:"",onClear:k,onKeyup:te(l,["enter"]),style:{width:"280px"}},null,8,["modelValue"]),c("div",_e,[o(n,{modelValue:U.value,"onUpdate:modelValue":t[1]||(t[1]=u=>U.value=u),placeholder:"æœ€ä½Žä»·æ ¼",type:"number",step:"0.01",style:{width:"120px"},min:"0"},null,8,["modelValue"]),t[6]||(t[6]=c("span",{style:{color:"#999",margin:"0 8px"}},"è‡³",-1)),o(n,{modelValue:F.value,"onUpdate:modelValue":t[2]||(t[2]=u=>F.value=u),placeholder:"æœ€é«˜ä»·æ ¼",type:"number",step:"0.01",style:{width:"120px"},min:"0"},null,8,["modelValue"]),o(i,{type:"default",onClick:q},{default:s(()=>t[4]||(t[4]=[b("ç­›é€‰")])),_:1,__:[4]}),o(i,{type:"text",onClick:O,style:{color:"#999"}},{default:s(()=>t[5]||(t[5]=[b("é‡ç½®")])),_:1,__:[5]})]),o(i,{type:"primary",onClick:A},{default:s(()=>t[7]||(t[7]=[b("æ–°å¢žå›¾ä¹¦")])),_:1,__:[7]})])]),ee((C(),G(N,{data:E.value,border:"",style:{width:"100%","border-radius":"12px","margin-top":"16px"},"empty-text":"æš‚æ— å›¾ä¹¦æ•°æ®"},{default:s(()=>[o(d,{prop:"id",label:"ID",width:"60",align:"center"}),o(d,{label:"å°é¢",width:"100",align:"center"},{default:s(({row:u})=>[u.cover_url?(C(),$("img",{key:0,src:I(u.cover_url),class:"book-cover",alt:"å°é¢"},null,8,fe)):(C(),$("span",ge,"æš‚æ— "))]),_:1}),o(d,{prop:"title",label:"ä¹¦å"}),o(d,{prop:"author",label:"ä½œè€…"}),o(d,{prop:"price",label:"ä»·æ ¼",width:"120",align:"center"},{default:s(({row:u})=>[b(j(T(u.price)),1)]),_:1}),o(d,{prop:"publish_date",label:"å‡ºç‰ˆæ—¥æœŸ",formatter:L,width:"140"}),o(d,{label:"åº“å­˜",width:"160",align:"center"},{default:s(({row:u})=>[c("div",be,[c("div",null,[c("strong",null,j(u.available_count??"â€”"),1),t[9]||(t[9]=b(" å¯å€Ÿ"))]),c("div",he,"æ€» "+j(u.total_count??"â€”"),1)])]),_:1}),o(d,{prop:"status",label:"çŠ¶æ€",width:"140",align:"center"},{default:s(({row:u})=>[o(p,{type:H(u),"disable-transitions":""},{default:s(()=>[b(j(K(u)),1)]),_:2},1032,["type"])]),_:1}),o(d,{label:"æ“ä½œ",width:"220",align:"center"},{default:s(u=>[o(i,{size:"small",type:"primary",onClick:Q=>P(u.row)},{default:s(()=>t[10]||(t[10]=[b("ç¼–è¾‘")])),_:2,__:[10]},1032,["onClick"]),o(i,{size:"small",type:"danger",onClick:Q=>m(u.row.id)},{default:s(()=>t[11]||(t[11]=[b("åˆ é™¤")])),_:2,__:[11]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[J,a.value]]),c("div",ye,[o(_,{background:"",layout:"prev, pager, next, jumper, ->, total","current-page":h.value,"page-size":S.value,total:R.value,onCurrentChange:y},null,8,["current-page","page-size","total"])]),o(de,{modelValue:x.value,"onUpdate:modelValue":t[3]||(t[3]=u=>x.value=u),isEdit:g.value,formData:D.value,onSubmit:W},null,8,["modelValue","isEdit","formData"])])}}},Ce=Y(we,[["__scopeId","data-v-f3c0a3f6"]]);export{Ce as default};
