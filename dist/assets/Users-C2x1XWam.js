import{_ as oe,r as i,y as P,u as ue,k as j,l as ie,g as de,h as ce,c as A,a as _,q as me,b as l,s as pe,d as u,v as ve,i as fe,w as n,E as d,o as w,f as p,t as N,x as E}from"./index-CVtVCzsP.js";import{r as y,A as ge}from"./request-CSTMYV-j.js";const _e={class:"users-root"},ye={class:"users-header"},be={class:"users-actions"},he=["src"],Ce={class:"pager",style:{display:"flex","justify-content":"flex-end","margin-top":"12px"}},xe=["src"],Ve={key:1,class:"dialog-avatar placeholder"},$e="/default-avatar.png",ke={__name:"Users",setup(Ue){var M;const b=i([]),B=i(!1),h=i(""),C=i(1),S=i(10),L=i(0),v=i(!1),$=i(null),T=i(null),r=P({username:"",studentId:"",email:"",status:"active"}),m=i(""),x=i(null),q=e=>e?e.role!=="admin"?!0:Number(e.id)===U.value:!1,k=ue();(M=k.load)==null||M.call(k);const U=j(()=>Number(k.id||localStorage.getItem("userId")||0)),W=P({username:[{required:!0,message:"è¯·è¾“å…¥ç”¨æˆ·å",trigger:"blur"}],studentId:[{required:!0,message:"è¯·è¾“å…¥å­¦å·",trigger:"blur"}],email:[{type:"email",message:"è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼",trigger:"blur"}],status:[{required:!0,message:"è¯·é€‰æ‹©çŠ¶æ€",trigger:"change"}]}),I=()=>{m.value&&m.value.startsWith("blob:")&&URL.revokeObjectURL(m.value)},O=e=>{e!=null&&e.raw&&(I(),x.value=e.raw,m.value=URL.createObjectURL(e.raw))},G=j(()=>{if(!h.value)return b.value;const e=h.value.toLowerCase();return b.value.filter(t=>t.username&&t.username.toLowerCase().includes(e)||t.studentId&&t.studentId.toLowerCase().includes(e)||t.email&&t.email.toLowerCase().includes(e))}),f=async()=>{B.value=!0;try{const t=(await y.get("/users",{params:{page:C.value,limit:S.value,keyword:h.value||void 0}})).data||{};b.value=t.data||[],L.value=t.total||b.value.length}catch(e){console.error("è·å–ç”¨æˆ·å¤±è´¥:",e),d.error("åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥"),b.value=[],L.value=0}finally{B.value=!1}},K=(e=null)=>{e&&(v.value=!0,$.value=e.id,r.username=e.username||"",r.studentId=e.studentId||"",r.email=e.email||"",r.status=e.status||"active",I(),x.value=null,m.value=e.avatar?D(e.avatar):"")},H=async()=>{try{if(!T.value||(await T.value.validate(),!$.value))return;const e={username:r.username,studentId:r.studentId,email:r.email,status:r.status};if(x.value){const t=new FormData;Object.entries(e).forEach(([o,a])=>{t.append(o,a??"")}),t.append("avatar",x.value),await y.put(`/users/${$.value}`,t,{headers:{"Content-Type":"multipart/form-data"}})}else await y.put(`/users/${$.value}`,e);d.success("ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ"),v.value=!1,f()}catch(e){e!=="cancel"&&(console.error("è¡¨å•æäº¤å¤±è´¥:",e),d.error("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•"))}},J=async e=>{var t,o;try{const a=e.status==="active"?"inactive":"active";if(e.role==="admin"){const c=a==="active"?"å¯ç”¨":"ç¦ç”¨";await E.confirm(`ç¡®å®šè¦${c}ç®¡ç†å‘˜ ${e.username} å—ï¼Ÿ${a==="inactive"?"ç¦ç”¨åè¯¥ç®¡ç†å‘˜å°†æ— æ³•ç™»å½•ç³»ç»Ÿã€‚":""}`,`${c}ç®¡ç†å‘˜ç¡®è®¤`,{type:"warning",confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ"})}await y.patch(`/users/${e.id}/status`,{status:a}),e.status=a,d.success(`ç”¨æˆ·å·²${a==="active"?"å¯ç”¨":"ç¦ç”¨"}`)}catch(a){a!=="cancel"&&(console.error("çŠ¶æ€åˆ‡æ¢å¤±è´¥:",a),d.error(((o=(t=a.response)==null?void 0:t.data)==null?void 0:o.error)||"çŠ¶æ€ä¿®æ”¹å¤±è´¥"))}},Q=async e=>{var t,o;try{const a=Number(e.id)===U.value,c=a?`ç¡®å®šè¦å°†è‡ªå·±çš„å¯†ç é‡ç½®ä¸º 123456 å—ï¼Ÿ

é‡ç½®åæ‚¨éœ€è¦ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚`:`ç¡®å®šè¦å°† ${e.username} çš„å¯†ç é‡ç½®ä¸º 123456 å—ï¼Ÿ`;await E.confirm(c,"é‡ç½®å¯†ç ç¡®è®¤",{type:"warning",confirmButtonText:"ç¡®å®šé‡ç½®",cancelButtonText:"å–æ¶ˆ"}),await y.post(`/users/${e.id}/reset-password`,{password:"123456"}),d.success("å¯†ç å·²é‡ç½®ä¸º 123456"),a&&d.warning("æ‚¨çš„å¯†ç å·²é‡ç½®ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•")}catch(a){a!=="cancel"&&(console.error("å¯†ç é‡ç½®å¤±è´¥:",a),d.error(((o=(t=a.response)==null?void 0:t.data)==null?void 0:o.error)||"å¯†ç é‡ç½®å¤±è´¥"))}},X=async e=>{var t,o;try{if(Number(e.id)===U.value){d.warning("ä¸èƒ½åˆ é™¤å½“å‰ç™»å½•çš„ç”¨æˆ·");return}const a=e.role==="admin",c=a?`âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°†åˆ é™¤ç®¡ç†å‘˜è´¦æˆ· ${e.username}ï¼

åˆ é™¤ç®¡ç†å‘˜è´¦æˆ·å¯èƒ½å¯¼è‡´ç³»ç»Ÿç®¡ç†åŠŸèƒ½å—é™ï¼Œè¯·è°¨æ…æ“ä½œã€‚

åˆ é™¤åè¯¥ç”¨æˆ·çš„æ‰€æœ‰å€Ÿé˜…è®°å½•å°†è¢«è‡ªåŠ¨å½’è¿˜ã€‚

ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`:`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${e.username} å—ï¼Ÿåˆ é™¤åè¯¥ç”¨æˆ·çš„æ‰€æœ‰å€Ÿé˜…è®°å½•å°†è¢«è‡ªåŠ¨å½’è¿˜ã€‚`;await E.confirm(c,a?"åˆ é™¤ç®¡ç†å‘˜ç¡®è®¤":"åˆ é™¤ç¡®è®¤",{type:"danger",confirmButtonText:"ç¡®å®šåˆ é™¤",cancelButtonText:"å–æ¶ˆ",dangerouslyUseHTMLString:!1}),await y.delete(`/users/${e.id}`),d.success("ç”¨æˆ·å·²åˆ é™¤"),f()}catch(a){a!=="cancel"&&(console.error("ç”¨æˆ·åˆ é™¤å¤±è´¥:",a),d.error(((o=(t=a.response)==null?void 0:t.data)==null?void 0:o.error)||"åˆ é™¤å¤±è´¥"))}},Y=e=>{C.value=e,f()},Z=e=>{S.value=e,C.value=1,f()},F=()=>{C.value=1,f()},D=e=>{if(!e)return $e;if(e.startsWith("http://")||e.startsWith("https://"))return e;const t=ge.replace(/\/$/,""),o=e.startsWith("/")?e:`/${e}`;return`${t}${o}`};return ie(f),de(v,e=>{e||(I(),m.value="",x.value=null)}),ce(I),(e,t)=>{const o=u("el-input"),a=u("el-table-column"),c=u("el-tag"),g=u("el-button"),ee=u("el-table"),te=u("el-pagination"),V=u("el-form-item"),ae=u("el-upload"),R=u("el-option"),le=u("el-select"),se=u("el-form"),ne=u("el-dialog"),re=ve("loading");return w(),A("div",_e,[_("div",ye,[t[7]||(t[7]=_("h1",{class:"page-title"},"ğŸ‘¥ ç”¨æˆ·ç®¡ç†",-1)),_("div",be,[l(o,{modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=s=>h.value=s),placeholder:"æœç´¢ç”¨æˆ·å/å­¦å·/é‚®ç®±",clearable:"",onKeyup:pe(F,["enter"]),style:{width:"280px"}},null,8,["modelValue"])])]),me((w(),fe(ee,{data:G.value,border:"",stripe:"",style:{width:"100%","border-radius":"12px","margin-top":"16px"},"empty-text":"æš‚æ— ç”¨æˆ·æ•°æ®"},{default:n(()=>[l(a,{prop:"id",label:"ID",width:"60",align:"center"}),l(a,{label:"å¤´åƒ",width:"80",align:"center"},{default:n(({row:s})=>[_("img",{src:D(s.avatar),class:"avatar",alt:"å¤´åƒ"},null,8,he)]),_:1}),l(a,{prop:"username",label:"ç”¨æˆ·å"}),l(a,{prop:"studentId",label:"å­¦å·"}),l(a,{prop:"email",label:"é‚®ç®±"}),l(a,{prop:"role",label:"è§’è‰²",width:"100",align:"center"},{default:n(({row:s})=>[l(c,{type:s.role==="admin"?"danger":"success"},{default:n(()=>[p(N(s.role==="admin"?"ç®¡ç†å‘˜":"æ™®é€šç”¨æˆ·"),1)]),_:2},1032,["type"])]),_:1}),l(a,{prop:"status",label:"çŠ¶æ€",width:"100",align:"center"},{default:n(({row:s})=>[l(c,{type:s.status==="active"?"success":"info"},{default:n(()=>[p(N(s.status==="active"?"å¯ç”¨":"ç¦ç”¨"),1)]),_:2},1032,["type"])]),_:1}),l(a,{label:"æ“ä½œ",width:"300",align:"center"},{default:n(({row:s})=>[l(g,{size:"small",type:"primary",onClick:z=>K(s),disabled:s.role==="admin"&&!q(s)},{default:n(()=>t[8]||(t[8]=[p(" ç¼–è¾‘ ")])),_:2,__:[8]},1032,["onClick","disabled"]),l(g,{size:"small",type:s.status==="active"?"warning":"success",onClick:z=>J(s)},{default:n(()=>[p(N(s.status==="active"?"ç¦ç”¨":"å¯ç”¨"),1)]),_:2},1032,["type","onClick"]),l(g,{size:"small",type:"info",onClick:z=>Q(s)},{default:n(()=>t[9]||(t[9]=[p(" é‡ç½®å¯†ç  ")])),_:2,__:[9]},1032,["onClick"]),l(g,{size:"small",type:"danger",onClick:z=>X(s),disabled:s.role==="admin"&&Number(s.id)===U.value},{default:n(()=>t[10]||(t[10]=[p(" åˆ é™¤ ")])),_:2,__:[10]},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[re,B.value]]),_("div",Ce,[l(te,{background:"",layout:"prev, pager, next, jumper, ->, total","current-page":C.value,"page-size":S.value,total:L.value,onCurrentChange:Y,onSizeChange:Z},null,8,["current-page","page-size","total"])]),l(ne,{modelValue:v.value,"onUpdate:modelValue":t[6]||(t[6]=s=>v.value=s),title:"ç¼–è¾‘ç”¨æˆ·",width:"400px"},{footer:n(()=>[l(g,{onClick:t[5]||(t[5]=s=>v.value=!1)},{default:n(()=>t[12]||(t[12]=[p("å–æ¶ˆ")])),_:1,__:[12]}),l(g,{type:"primary",onClick:H},{default:n(()=>t[13]||(t[13]=[p("ç¡®å®š")])),_:1,__:[13]})]),default:n(()=>[l(se,{ref_key:"formRef",ref:T,model:r,rules:W,"label-width":"80px"},{default:n(()=>[l(V,{label:"ç”¨æˆ·å",prop:"username"},{default:n(()=>[l(o,{modelValue:r.username,"onUpdate:modelValue":t[1]||(t[1]=s=>r.username=s),placeholder:"è¯·è¾“å…¥ç”¨æˆ·å"},null,8,["modelValue"])]),_:1}),l(V,{label:"å­¦å·",prop:"studentId"},{default:n(()=>[l(o,{modelValue:r.studentId,"onUpdate:modelValue":t[2]||(t[2]=s=>r.studentId=s),placeholder:"è¯·è¾“å…¥å­¦å·"},null,8,["modelValue"])]),_:1}),l(V,{label:"é‚®ç®±",prop:"email"},{default:n(()=>[l(o,{modelValue:r.email,"onUpdate:modelValue":t[3]||(t[3]=s=>r.email=s),type:"email",placeholder:"è¯·è¾“å…¥é‚®ç®±"},null,8,["modelValue"])]),_:1}),l(V,{label:"å¤´åƒ"},{default:n(()=>[l(ae,{class:"dialog-avatar-uploader",action:"#","show-file-list":!1,"auto-upload":!1,accept:"image/*",onChange:O},{default:n(()=>[m.value?(w(),A("img",{key:0,src:m.value,class:"dialog-avatar"},null,8,xe)):(w(),A("div",Ve,"ä¸Šä¼ å¤´åƒ"))]),_:1}),t[11]||(t[11]=_("div",{class:"avatar-hint"},"æ”¯æŒ JPG/PNGï¼Œæœ€å¤§ 2MB",-1))]),_:1,__:[11]}),l(V,{label:"çŠ¶æ€",prop:"status"},{default:n(()=>[l(le,{modelValue:r.status,"onUpdate:modelValue":t[4]||(t[4]=s=>r.status=s),placeholder:"è¯·é€‰æ‹©çŠ¶æ€"},{default:n(()=>[l(R,{label:"å¯ç”¨",value:"active"}),l(R,{label:"ç¦ç”¨",value:"inactive"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}},Be=oe(ke,[["__scopeId","data-v-169e4779"]]);export{Be as default};
