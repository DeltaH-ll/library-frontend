import{_ as se,r as d,k as F,g as ne,l as ie,c as h,a as v,q as ue,b as s,w as i,d as c,s as de,f as m,t as j,v as ce,i as k,E as u,o as p,j as W,F as K,n as L,x as H}from"./index-CVtVCzsP.js";import{r as b,A as pe}from"./request-CSTMYV-j.js";const _e={class:"borrow-root"},me={class:"borrow-header"},ve={style:{display:"flex",gap:"12px","align-items":"center"}},fe={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"12px"}},ge={style:{display:"flex",gap:"8px","align-items":"center"}},be={style:{color:"#666"}},ye=["src"],we={key:1,class:"no-cover"},he={style:{"text-align":"right","margin-top":"12px"}},ke={__name:"Borrow",setup(xe){const V=d([]),x=d(0),$=d(1),N=d(6),B=d(""),C=d(!1),y=d(!1),_=d({book_id:"",user_id:""}),D=d(null),S=d(!1),I=d([]),U=d([]),P=F(()=>(I.value||[]).filter(t=>Number((t==null?void 0:t.available_count)||0)>0)),Y=t=>{if(!t)return"";if(t.startsWith("http://")||t.startsWith("https://"))return t;const e=pe.replace(/\/$/,""),o=t.startsWith("/")?t:`/${t}`;return`${e}${o}`},G=localStorage.getItem("userId")||null,J=localStorage.getItem("role")||null,f=F(()=>J==="admin"),R=t=>{if(!t)return"â€”";const e=Date.parse(t.replace(/-/g,"/"));if(isNaN(e))return t;const o=new Date(e),r=l=>String(l).padStart(2,"0");return`${o.getFullYear()}-${r(o.getMonth()+1)}-${r(o.getDate())} ${r(o.getHours())}:${r(o.getMinutes())}:${r(o.getSeconds())}`},g=async()=>{var t,e;C.value=!0;try{const r=(await b.get("/borrow",{params:{page:$.value,limit:N.value,q:B.value.trim()}})).data||{},l=r.data||[];x.value=r.total??l.length,V.value=l.map(n=>({...n,borrow_date:R(n.borrow_date),return_date:R(n.return_date),username:n.username||"æœªçŸ¥ç”¨æˆ·",studentId:n.studentId||"â€”",email:n.email||"â€”"}))}catch(o){console.error("è·å–å€Ÿé˜…è®°å½•å¤±è´¥:",o);const r=((t=o.response)==null?void 0:t.status)===401?"è¯·å…ˆç™»å½•":((e=o.response)==null?void 0:e.status)===404?"å€Ÿé˜…è®°å½•æ¥å£ä¸å­˜åœ¨":"åŠ è½½å€Ÿé˜…è®°å½•å¤±è´¥";u.error(r),V.value=[],x.value=0}finally{C.value=!1}},w=async()=>{try{const e=(await b.get("/books",{params:{page:1,limit:1e3,status:"åœ¨é¦†"}})).data||{};I.value=e.data||[]}catch(t){console.error("è·å–å›¾ä¹¦åˆ—è¡¨å¤±è´¥:",t),u.error("åŠ è½½å›¾ä¹¦åˆ—è¡¨å¤±è´¥ï¼Œæ— æ³•å€Ÿä¹¦"),I.value=[]}},M=async()=>{if(f.value)try{const e=(await b.get("/users")).data||{};U.value=e.data||[]}catch(t){console.error("è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:",t),u.error("åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥"),U.value=[]}},O=()=>{_.value={book_id:"",user_id:f.value?"":G||""},y.value=!0,w(),f.value&&M()},Q=async()=>{var t,e,o,r;if(D.value){try{await D.value.validate()}catch{u.error("è¯·å¡«å†™å®Œæ•´å€Ÿä¹¦ä¿¡æ¯");return}S.value=!0;try{const l=f.value?{book_id:_.value.book_id,user_id:_.value.user_id}:{book_id:_.value.book_id},n=await b.post("/borrow",l);(t=n.data)!=null&&t.success?(u.success("å€Ÿä¹¦æˆåŠŸ"),y.value=!1,g(),w()):u.error("å€Ÿä¹¦å¤±è´¥ï¼š"+(((e=n.data)==null?void 0:e.error)||"æœªçŸ¥é”™è¯¯"))}catch(l){console.error("å€Ÿä¹¦è¯·æ±‚å¤±è´¥:",l);const n=((r=(o=l.response)==null?void 0:o.data)==null?void 0:r.error)||"ç½‘ç»œé”™è¯¯ï¼Œå€Ÿä¹¦å¤±è´¥";u.error(n)}finally{S.value=!1}}},X=async t=>{var e,o;if(t)try{await H.confirm("ç¡®è®¤å½’è¿˜è¯¥å›¾ä¹¦å—ï¼Ÿ","è¿˜ä¹¦ç¡®è®¤",{confirmButtonText:"ç¡®è®¤",cancelButtonText:"å–æ¶ˆ",type:"warning"});const r=await b.put(`/borrow/${t}/return`);(e=r.data)!=null&&e.success?(u.success("è¿˜ä¹¦æˆåŠŸ"),g(),w()):u.error("è¿˜ä¹¦å¤±è´¥ï¼š"+(((o=r.data)==null?void 0:o.error)||"æœªçŸ¥é”™è¯¯"))}catch(r){r!=="cancel"&&(console.error("è¿˜ä¹¦è¯·æ±‚å¤±è´¥:",r),u.error("è¿˜ä¹¦å¤±è´¥ï¼Œè¯·é‡è¯•"))}},Z=async t=>{var e,o,r,l;if(t)try{await H.confirm("ç¡®è®¤åˆ é™¤è¯¥å€Ÿé˜…è®°å½•å—ï¼Ÿåˆ é™¤åIDå°†è‡ªåŠ¨é‡æ–°æ’åºã€‚","åˆ é™¤ç¡®è®¤",{confirmButtonText:"ç¡®è®¤åˆ é™¤",cancelButtonText:"å–æ¶ˆ",type:"warning"});const n=await b.delete(`/borrow/${t}`);(e=n.data)!=null&&e.success?(u.success("åˆ é™¤æˆåŠŸ"),g(),w()):u.error("åˆ é™¤å¤±è´¥ï¼š"+(((o=n.data)==null?void 0:o.error)||"æœªçŸ¥é”™è¯¯"))}catch(n){if(n!=="cancel"){console.error("åˆ é™¤å€Ÿé˜…è®°å½•å¤±è´¥:",n);const E=((l=(r=n.response)==null?void 0:r.data)==null?void 0:l.error)||"åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•";u.error(E)}}},ee=t=>{$.value=t,g()},T=()=>{$.value=1,g()};return ne(f,t=>{t&&M()}),ie(()=>{g(),w(),f.value&&M()}),(t,e)=>{const o=c("el-button"),r=c("el-input"),l=c("el-table-column"),n=c("el-tag"),E=c("el-table"),te=c("el-pagination"),q=c("el-option"),z=c("el-select"),A=c("el-form-item"),ae=c("el-form"),oe=c("el-dialog"),re=ce("loading");return p(),h("div",_e,[v("div",me,[e[6]||(e[6]=v("h1",{class:"borrow-title"},"ğŸ“– å€Ÿé˜…ç®¡ç†",-1)),v("div",ve,[s(o,{type:"primary",onClick:O},{default:i(()=>e[5]||(e[5]=[m("å€Ÿä¹¦")])),_:1,__:[5]})])]),v("div",fe,[v("div",ge,[s(r,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),placeholder:"æŒ‰ä¹¦åã€å€Ÿé˜…äººã€å­¦å·æˆ–é‚®ç®±æœç´¢",clearable:"",onKeyup:de(T,["enter"]),style:{width:"320px"}},null,8,["modelValue"]),s(o,{onClick:T},{default:i(()=>e[7]||(e[7]=[m("æŸ¥è¯¢")])),_:1,__:[7]})]),v("div",be,[e[8]||(e[8]=m("å…± ")),v("strong",null,j(x.value),1),e[9]||(e[9]=m(" æ¡å€Ÿé˜…è®°å½•"))])]),ue((p(),k(E,{data:V.value,border:"","empty-text":"æš‚æ— å€Ÿé˜…è®°å½•",style:{width:"100%","border-radius":"12px","margin-top":"8px"}},{default:i(()=>[s(l,{prop:"id",label:"ID",width:"60",align:"center"}),s(l,{label:"å°é¢",width:"110",align:"center"},{default:i(({row:a})=>[a.cover_url?(p(),h("img",{key:0,src:Y(a.cover_url),class:"cover-thumb",alt:"å°é¢"},null,8,ye)):(p(),h("span",we,"æš‚æ— "))]),_:1}),s(l,{prop:"book_title",label:"ä¹¦å"}),s(l,{prop:"username",label:"å€Ÿé˜…äºº"}),s(l,{prop:"studentId",label:"å­¦å·"}),s(l,{prop:"email",label:"é‚®ç®±"}),s(l,{prop:"borrow_date",label:"å€Ÿå‡ºæ—¶é—´",width:"200"}),s(l,{prop:"return_date",label:"è¿˜ä¹¦æ—¶é—´",width:"200"}),s(l,{prop:"status",label:"çŠ¶æ€",width:"120",align:"center"},{default:i(({row:a})=>[s(n,{type:a.status==="å·²è¿˜"?"success":a.status==="å€Ÿå‡º"?"warning":"info"},{default:i(()=>[m(j(a.status),1)]),_:2},1032,["type"])]),_:1}),s(l,{label:"æ“ä½œ",width:"200",align:"center"},{default:i(({row:a})=>[a.status==="å€Ÿå‡º"?(p(),k(o,{key:0,size:"small",type:"success",onClick:le=>X(a.id)},{default:i(()=>e[10]||(e[10]=[m("è¿˜ä¹¦")])),_:2,__:[10]},1032,["onClick"])):W("",!0),s(o,{size:"small",type:"danger",onClick:le=>Z(a.id)},{default:i(()=>e[11]||(e[11]=[m("åˆ é™¤")])),_:2,__:[11]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[re,C.value]]),v("div",he,[s(te,{"current-page":$.value,"page-size":N.value,total:x.value,layout:"prev, pager, next, jumper",onCurrentChange:ee},null,8,["current-page","page-size","total"])]),s(oe,{modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=a=>y.value=a),title:"å€Ÿä¹¦",width:"520px"},{footer:i(()=>[s(o,{onClick:e[3]||(e[3]=a=>y.value=!1)},{default:i(()=>e[12]||(e[12]=[m("å–æ¶ˆ")])),_:1,__:[12]}),s(o,{type:"primary",onClick:Q,loading:S.value},{default:i(()=>e[13]||(e[13]=[m("ç¡®å®š")])),_:1,__:[13]},8,["loading"])]),default:i(()=>[s(ae,{ref_key:"formRef",ref:D,model:_.value,"label-width":"90px"},{default:i(()=>[s(A,{label:"å›¾ä¹¦",prop:"book_id",rules:[{required:!0,message:"è¯·é€‰æ‹©å›¾ä¹¦",trigger:"change"}]},{default:i(()=>[s(z,{modelValue:_.value.book_id,"onUpdate:modelValue":e[1]||(e[1]=a=>_.value.book_id=a),placeholder:"è¯·é€‰æ‹©å›¾ä¹¦",filterable:"",style:{width:"100%"}},{default:i(()=>[(p(!0),h(K,null,L(P.value,a=>(p(),k(q,{key:a.id,label:`${a.title}ï¼ˆå‰© ${a.available_count} / æ€» ${a.total_count}ï¼‰`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),f.value?(p(),k(A,{key:0,label:"å€Ÿé˜…äºº",prop:"user_id",rules:[{required:!0,message:"è¯·é€‰æ‹©å€Ÿé˜…äºº",trigger:"change"}]},{default:i(()=>[s(z,{modelValue:_.value.user_id,"onUpdate:modelValue":e[2]||(e[2]=a=>_.value.user_id=a),placeholder:"è¯·é€‰æ‹©ç”¨æˆ·",filterable:"",style:{width:"100%"}},{default:i(()=>[(p(!0),h(K,null,L(U.value,a=>(p(),k(q,{key:a.id,label:`${a.username}ï¼ˆå­¦å·ï¼š${a.studentId||"æ— "} | é‚®ç®±ï¼š${a.email||"æ— "}ï¼‰`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):W("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Be=se(ke,[["__scopeId","data-v-b2c5d1b8"]]);export{Be as default};
